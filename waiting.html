<script>
  function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
  }

  const responseId = getQueryParam("responseId");
  let retries = 0;
  const maxRetries = 20; // retry every 3s up to 60 seconds

  async function pollForPDF() {
    try {
      const res = await fetch("https://opensheet.elk.sh/1Qeb007QbCDJKIaA5MlniqMDk98gZ0DOo5Gyacu9VjdM/Sheet1");
      const data = await res.json();

      const row = data.find(entry => entry.responseId === responseId);

      if (row && row.PDF_URL) {
        document.getElementById("downloadLink").href = row.PDF_URL;
        document.getElementById("link").classList.remove("hidden");
        document.querySelector(".loading").style.display = "none";
        return;
      }

      retries++;
      if (retries < maxRetries) {
        setTimeout(pollForPDF, 3000);
      } else {
        document.querySelector(".loading").textContent = "Still generating your SOAP note… please refresh this page in a few seconds.";
      }

    } catch (err) {
      console.error("Polling error:", err);
      setTimeout(pollForPDF, 5000);
    }
  }

  if (responseId) {
    pollForPDF();
  } else {
    document.querySelector(".loading").textContent = "Missing response ID — please resubmit the form.";
  }
</script>
</html>
